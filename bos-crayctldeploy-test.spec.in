#
# MIT License
#
# (C) Copyright 2020-2022 Hewlett Packard Enterprise Development LP
#
# Permission is hereby granted, free of charge, to any person obtaining a
# copy of this software and associated documentation files (the "Software"),
# to deal in the Software without restriction, including without limitation
# the rights to use, copy, modify, merge, publish, distribute, sublicense,
# and/or sell copies of the Software, and to permit persons to whom the
# Software is furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included
# in all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR
# OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
# ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
# OTHER DEALINGS IN THE SOFTWARE.
#

Name: bos-crayctldeploy-test
License: MIT
Summary: Cray post-install tests for Boot Orchestration Services (BOS)
Group: System/Management
# The version is substituted at build time by runBuildPrep.sh
Version: @RPM_VERSION@
Release: @RPM_RELEASE@
Source: %{name}-@RPM_VERSION@-@RPM_RELEASE@.tar.bz2
Vendor: Cray Inc.
Requires: cray-cmstools-crayctldeploy-test >= 0.2.11
Conflicts: cray-crus-crayctldeploy-test < 0.2.9
Requires: python3-requests

# Test defines. These may make sense to put in a central location
%define craydir /opt/cray
%define tests %{craydir}/tests
%define smsfunc %{tests}/sms-functional
%define testdat %{tests}/dat
%define testlib %{tests}/lib

# CMS test defines
%define smsfunccms %{smsfunc}/cms
%define cmsdat %{testdat}/cms
%define cmslib %{testlib}/cms
%define cmscommon %{cmslib}/common

# BOS test defines
%define bosfunctestdat %{cmsdat}/bos_functional_test
%define bosfunctestlib %{cmslib}/bos_functional_test
%define boslimittestlib %{cmslib}/bos_limit_test

%description
This is a collection of post-install tests for the Boot Orchestration Services (BOS).

%prep
%setup -q

%build

%install

# Install test wrapper scripts
install -m 755 -d %{buildroot}%{smsfunccms}/
install ct-tests/bos_api_functional_test.sh %{buildroot}%{smsfunccms}
install ct-tests/bos_cli_functional_test.sh %{buildroot}%{smsfunccms}

# Install shared test libraries
# The cmscommon directory should already exist, since we have
# cray-cmstools-crayctldeploy-test as a prerequisite, but just in
# case...
install -m 755 -d %{buildroot}%{cmscommon}/
install -m 644 ct-tests/lib/common/bos.py %{buildroot}%{cmscommon}
install -m 644 ct-tests/lib/common/bosutils.py %{buildroot}%{cmscommon}

# Install BOS functional test
install -m 755 ct-tests/lib/bos_functional_test.py %{buildroot}%{cmslib}
install -m 755 -d %{buildroot}%{bosfunctestdat}/
install -m 644 ct-tests/dat/bos_functional_test/bos_session_template.json %{buildroot}%{bosfunctestdat}
install -m 755 -d %{buildroot}%{bosfunctestlib}/
install -m 644 ct-tests/lib/bos_functional_test/__init__.py %{buildroot}%{bosfunctestlib}
install -m 644 ct-tests/lib/bos_functional_test/argparse.py %{buildroot}%{bosfunctestlib}
install -m 644 ct-tests/lib/bos_functional_test/helpers.py %{buildroot}%{bosfunctestlib}

# Install BOS limit test
install -m 755 ct-tests/lib/bos_limit_test.py %{buildroot}%{cmslib}
install -m 755 -d %{buildroot}%{boslimittestlib}/
install -m 644 ct-tests/lib/bos_limit_test/__init__.py %{buildroot}%{boslimittestlib}
install -m 644 ct-tests/lib/bos_limit_test/argparse.py %{buildroot}%{boslimittestlib}
install -m 644 ct-tests/lib/bos_limit_test/hsm.py %{buildroot}%{boslimittestlib}
install -m 644 ct-tests/lib/bos_limit_test/utils.py %{buildroot}%{boslimittestlib}

# Install BOS loop test
install -m 755 ct-tests/lib/bos_loop.py %{buildroot}%{cmslib}

%clean
rm -f %{buildroot}%{smsfunccms}/bos_api_functional_test.sh
rm -f %{buildroot}%{smsfunccms}/bos_cli_functional_test.sh

rm -f %{buildroot}%{cmscommon}/bos.py
rm -f %{buildroot}%{cmscommon}/bosutils.py

rm -f %{buildroot}%{cmslib}/bos_functional_test.py
rm -f %{buildroot}%{bosfunctestdat}/bos_session_template.json
rm -f %{buildroot}%{bosfunctestlib}/__init__.py
rm -f %{buildroot}%{bosfunctestlib}/argparse.py
rm -f %{buildroot}%{bosfunctestlib}/helpers.py

rm -f %{buildroot}%{cmslib}/bos_limit_test.py
rm -f %{buildroot}%{boslimittestlib}/__init__.py
rm -f %{buildroot}%{boslimittestlib}/argparse.py
rm -f %{buildroot}%{boslimittestlib}/hsm.py
rm -f %{buildroot}%{boslimittestlib}/utils.py

rm -f %{buildroot}%{cmslib}/bos_loop.py

rmdir %{buildroot}%{boslimittestlib}
rmdir %{buildroot}%{bosfunctestdat}
rmdir %{buildroot}%{bosfunctestlib}

%files
%defattr(755, root, root)
%dir %{bosfunctestdat}
%dir %{bosfunctestlib}
%dir %{boslimittestlib}

%attr(755, root, root) %{smsfunccms}/bos_api_functional_test.sh
%attr(755, root, root) %{smsfunccms}/bos_cli_functional_test.sh

%attr(644, root, root) %{cmscommon}/bos.py
%attr(644, root, root) %{cmscommon}/bosutils.py

%attr(755, root, root) %{cmslib}/bos_functional_test.py
%attr(644, root, root) %{bosfunctestdat}/bos_session_template.json
%attr(644, root, root) %{bosfunctestlib}/__init__.py
%attr(644, root, root) %{bosfunctestlib}/argparse.py
%attr(644, root, root) %{bosfunctestlib}/helpers.py

%attr(755, root, root) %{cmslib}/bos_limit_test.py
%attr(644, root, root) %{boslimittestlib}/__init__.py
%attr(644, root, root) %{boslimittestlib}/argparse.py
%attr(644, root, root) %{boslimittestlib}/hsm.py
%attr(644, root, root) %{boslimittestlib}/utils.py

%attr(755, root, root) %{cmslib}/bos_loop.py

%changelog
